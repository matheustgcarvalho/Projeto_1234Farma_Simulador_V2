<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FarmaFácil - Carrinho</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
       :root { --tech-purple: #2E1A47; --neon-mint: #69FFC2; --pure-white: #FFFFFF; --warning-red: #ff4757; --alert-orange: #ff9800; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Roboto, Arial, sans-serif; }
        
        /* Fonte base reduzida para caber no tablet */
        body { 
            background-color: var(--tech-purple); 
            color: var(--pure-white); 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            font-size: 13px; 
        }
        
        /* HEADER COMPACTO */
        header { 
            background-color: rgba(46, 26, 71, 0.95); 
            padding: 10px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--neon-mint); 
            flex-shrink: 0; 
            gap: 10px; 
        }
        .user-name-display { font-size: 0.9rem; font-weight: 700; color: var(--neon-mint); }
        
        .btn-exit-header { background: none; border: none; color: rgba(255,255,255,0.6); cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: 600; font-size: 0.8rem; }
        .btn-exit-header:hover { color: var(--warning-red); }

        .btn-back-shop { 
            text-decoration: none; color: var(--neon-mint); display: flex; align-items: center; gap: 5px; font-weight: 700; 
            border: 1px solid var(--neon-mint); padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; 
        }

        /* CONTEÚDO PRINCIPAL */
        main { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; width: 100%; }
        
        .cart-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .page-title { font-size: 1.3rem; display: flex; align-items: center; gap: 8px; color: var(--neon-mint); margin: 0; }
        
        .btn-clear-cart { 
            background: none; border: 1px solid rgba(255,255,255,0.3); color: rgba(255,255,255,0.7); 
            padding: 5px 10px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.75rem; transition: all 0.3s;
        }
        .btn-clear-cart:hover { border-color: var(--warning-red); color: var(--warning-red); background-color: rgba(255, 71, 87, 0.1); }

        .cart-list-container { display: flex; flex-direction: column; gap: 10px; }
        
        /* CARD DE ITEM REDUZIDO */
        .cart-item { 
            background-color: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px; 
            display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(105, 255, 194, 0.2); 
        }
        
        .cart-item-left { display: flex; align-items: center; gap: 10px; }
        .cart-item-img {
            width: 50px; height: 50px; /* Imagem menor */
            object-fit: cover; border-radius: 6px; background-color: white;
        }

        .item-name { font-size: 0.95rem; font-weight: 700; margin-bottom: 2px; line-height: 1.1;}
        .item-price-unit { font-size: 0.75rem; color: rgba(255,255,255,0.6); }
        .item-price-total { color: var(--neon-mint); font-weight: 700; font-size: 0.9rem; margin-top: 2px;}

        /* CONTROLES MENORES */
        .quantity-controls {
            display: flex; align-items: center; gap: 8px;
            background-color: rgba(0,0,0,0.2); padding: 4px; border-radius: 20px;
        }
        .btn-qty {
            width: 24px; height: 24px; border-radius: 50%; border: none; cursor: pointer; 
            display: flex; justify-content: center; align-items: center; 
        }
        .btn-decrease { background-color: transparent; border: 1px solid var(--warning-red); color: var(--warning-red); }
        .qty-display { font-weight: 700; font-size: 0.9rem; min-width: 20px; text-align: center; }
        .btn-increase { background-color: var(--neon-mint); color: var(--tech-purple); }

        .empty-cart-message { text-align: center; padding: 30px; color: rgba(255,255,255,0.5); font-size: 1rem; }

        /* FOOTER COMPACTO */
        footer { 
            background-color: rgba(46, 26, 71, 0.98); padding: 10px 15px; 
            border-top: 1px solid rgba(105, 255, 194, 0.3); flex-shrink: 0; 
        }
        .cart-total-summary { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 1rem; }
        .total-value { color: var(--neon-mint); font-size: 1.4rem; font-weight: 800; }
        .btn-finish-order { 
            width: 100%; background-color: var(--neon-mint); color: var(--tech-purple); 
            padding: 10px; border-radius: 10px; font-weight: 800; border: none; 
            font-size: 1rem; cursor: pointer; display: flex; justify-content: center; alignItems: center; gap: 8px;
        }

        /* --- ESTILOS DOS MODAIS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.85);
            backdrop-filter: blur(3px);
            z-index: 1000;
            display: none; /* Escondido por padrão */
            justify-content: center; align-items: center;
        }
        
        .modal-content {
            background-color: #2a1b3d;
            border: 1px solid var(--neon-mint);
            border-radius: 15px;
            padding: 25px;
            width: 85%;
            max-width: 350px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            animation: modalPop 0.3s ease-out;
        }
        @keyframes modalPop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .modal-icon { font-size: 3.5rem; margin-bottom: 15px; }
        .modal-title { font-size: 1.3rem; font-weight: 800; color: white; margin-bottom: 10px; }
        .modal-text { font-size: 1rem; color: rgba(255,255,255,0.7); margin-bottom: 25px; line-height: 1.4; }
        
        .modal-actions { display: flex; gap: 15px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; font-size: 1rem;}
        .btn-modal-cancel { background-color: rgba(255,255,255,0.1); color: white; }
        
        /* ESTILOS ESPECÍFICOS PARA CADA TIPO DE MODAL */
        /* Modal de Perigo (Esvaziar) */
        .modal-danger .modal-icon { color: var(--warning-red); }
        .modal-danger .btn-modal-confirm { background-color: var(--warning-red); color: white; }
        
        /* Modal de Aviso (Quantidade) */
        .modal-warning .modal-icon { color: var(--alert-orange); }
        .modal-warning .btn-modal-confirm { background-color: var(--alert-orange); color: white; }

    </style>
</head>
<body>

    <header>
        <a href="loja.html" class="btn-back-shop">
            <span class="material-icons" style="font-size: 1rem;">arrow_back</span> Loja
        </a>
        <div style="text-align: center;">
             <span class="welcome-text" style="font-size: 0.7rem; opacity: 0.7;">Carrinho de</span><br>
             <span id="userNameDisplay" class="user-name-display">...</span>
        </div>
        <button id="btnExit" class="btn-exit-header">
            <span class="material-icons" style="font-size: 1.1rem;">logout</span>
        </button>
    </header>

    <main>
        <div class="cart-header-row">
            <h1 class="page-title"><span class="material-icons" style="font-size: 1.5rem;">shopping_cart</span> Carrinho</h1>
            <button id="btnClearCart" class="btn-clear-cart">
                <span class="material-icons" style="font-size: 1rem;">delete_sweep</span> Limpar
            </button>
        </div>
        
        <div id="cartListContainer" class="cart-list-container">
            </div>
    </main>

    <footer>
        <div class="cart-total-summary">
            <span>Total a pagar:</span>
            <span id="totalValueDisplay" class="total-value">R$ 0,00</span>
        </div>
        <button class="btn-finish-order">
            <span class="material-icons">credit_card</span> FINALIZAR PAGAMENTO
        </button>
    </footer>

    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content modal-danger">
            <div class="material-icons modal-icon">delete_forever</div>
            <div class="modal-title">Esvaziar Carrinho?</div>
            <div class="modal-text">Tem certeza que deseja remover todos os itens? Essa ação não pode ser desfeita.</div>
            <div class="modal-actions">
                <button id="btnCancelClear" class="modal-btn btn-modal-cancel">Cancelar</button>
                <button id="btnConfirmClear" class="modal-btn btn-modal-confirm">Sim, Esvaziar</button>
            </div>
        </div>
    </div>

    <div id="qtyWarningModal" class="modal-overlay">
        <div class="modal-content modal-warning">
            <div class="material-icons modal-icon">health_and_safety</div>
            <div class="modal-title">Atenção à Saúde</div>
            <div class="modal-text">
                Importante: O uso excessivo de qualquer medicamento sem a prescrição de um profissional pode causar prejuízos à sua saúde.
                <br><br>
                <strong>Deseja continuar comprando mais de 3 unidades desse medicamento?</strong>
            </div>
            <div class="modal-actions">
                <button id="btnCancelQty" class="modal-btn btn-modal-cancel">Não</button>
                <button id="btnConfirmQty" class="modal-btn btn-modal-confirm">Sim, desejo</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Login Check
            const nomeSalvo = sessionStorage.getItem('usuarioFarmaFacil');
            if (!nomeSalvo) { window.location.href = 'login.html'; return; }
            document.getElementById('userNameDisplay').textContent = nomeSalvo.split(' ')[0]; // Só primeiro nome
            
            document.getElementById('btnExit').addEventListener('click', function() {
                sessionStorage.removeItem('usuarioFarmaFacil'); window.location.href = 'login.html';
            });

            // LER O CARRINHO BRUTO
            let carrinhoBruto = JSON.parse(sessionStorage.getItem('carrinhoFarmaFacil')) || [];
            
            const cartListContainer = document.getElementById('cartListContainer');
            const totalValueDisplay = document.getElementById('totalValueDisplay');
            const btnClearCart = document.getElementById('btnClearCart');
            
            // Elementos dos Modais
            const confirmModal = document.getElementById('confirmModal');
            const btnCancelClear = document.getElementById('btnCancelClear');
            const btnConfirmClear = document.getElementById('btnConfirmClear');

            const qtyWarningModal = document.getElementById('qtyWarningModal');
            const btnCancelQty = document.getElementById('btnCancelQty');
            const btnConfirmQty = document.getElementById('btnConfirmQty');

            // Variável para guardar qual item está pendente de adição (regra > 3)
            let pendingItemId = null;

            // --- LÓGICA DO MODAL LIMPAR ---
            btnClearCart.addEventListener('click', function() {
                if(carrinhoBruto.length > 0) confirmModal.style.display = 'flex';
            });
            btnCancelClear.addEventListener('click', () => confirmModal.style.display = 'none');
            btnConfirmClear.addEventListener('click', () => {
                carrinhoBruto = [];
                salvarERenderizar();
                confirmModal.style.display = 'none';
            });

            // --- LÓGICA DO MODAL DE QUANTIDADE ---
            btnCancelQty.addEventListener('click', () => {
                qtyWarningModal.style.display = 'none';
                pendingItemId = null; // Cancela
            });

            btnConfirmQty.addEventListener('click', () => {
                // Usuário confirmou, adiciona o item pendente
                if(pendingItemId) {
                    const itemToAdd = carrinhoBruto.find(item => item.id === pendingItemId);
                    if(itemToAdd) {
                        carrinhoBruto.push(itemToAdd);
                        salvarERenderizar();
                    }
                }
                qtyWarningModal.style.display = 'none';
                pendingItemId = null;
            });

            // Finalizar Pagamento
            const btnFinish = document.querySelector('.btn-finish-order');
            btnFinish.addEventListener('click', function() {
                if (carrinhoBruto.length === 0) {
                    alert("Seu carrinho está vazio!");
                    return;
                }
                window.location.href = 'metodopagamento.html';
            });

            function salvarERenderizar() {
                sessionStorage.setItem('carrinhoFarmaFacil', JSON.stringify(carrinhoBruto));
                renderizarCarrinho();
            }

            function agruparItens(arrayBruto) {
                const agrupado = {};
                arrayBruto.forEach(item => {
                    if (agrupado[item.id]) {
                        agrupado[item.id].quantidade += 1;
                    } else {
                        agrupado[item.id] = { ...item, quantidade: 1 };
                    }
                });
                return Object.values(agrupado);
            }

            function renderizarCarrinho() {
                cartListContainer.innerHTML = ''; 
                let totalGeral = 0;

                // Visibilidade do botão limpar
                if (carrinhoBruto.length === 0) {
                    btnClearCart.style.display = 'none'; 
                    cartListContainer.innerHTML = '<div class="empty-cart-message"><span class="material-icons" style="font-size: 3rem; margin-bottom: 10px; display: block;">remove_shopping_cart</span>Vazio</div>';
                    totalValueDisplay.textContent = 'R$ 0,00';
                    return;
                } else {
                    btnClearCart.style.display = 'flex';
                }

                const itensAgrupados = agruparItens(carrinhoBruto);

                itensAgrupados.forEach(produto => {
                    const precoTotalItem = produto.preco * produto.quantidade;
                    totalGeral += precoTotalItem;
                    
                    const itemElement = document.createElement('div');
                    itemElement.classList.add('cart-item');
                    
                    itemElement.innerHTML = `
                        <div class="cart-item-left">
                            <img src="${produto.imagem}" class="cart-item-img" alt="Foto">
                            <div>
                                <div class="item-name">${produto.nome}</div>
                                <div class="item-price-unit">Unit: R$ ${produto.preco.toFixed(2).replace('.',',')}</div>
                                <div class="item-price-total">Total: R$ ${precoTotalItem.toFixed(2).replace('.',',')}</div>
                            </div>
                        </div>

                        <div class="quantity-controls">
                            <button class="btn-qty btn-decrease" data-id="${produto.id}">
                                <span class="material-icons" style="font-size: 1rem;">remove</span>
                            </button>
                            
                            <span class="qty-display">${produto.quantidade}</span>
                            
                            <button class="btn-qty btn-increase" data-id="${produto.id}">
                                <span class="material-icons" style="font-size: 1rem;">add</span>
                            </button>
                        </div>
                    `;
                    cartListContainer.appendChild(itemElement);
                });

                totalValueDisplay.textContent = 'R$ ' + totalGeral.toFixed(2).replace('.',',');
                atribuirBotoes();
            }

            function atribuirBotoes() {
                // Diminuir
                document.querySelectorAll('.btn-decrease').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        const index = carrinhoBruto.findIndex(item => item.id === id);
                        if (index !== -1) {
                            carrinhoBruto.splice(index, 1);
                            salvarERenderizar();
                        }
                    });
                });

                // Aumentar (COM REGRA DE TRAVA)
                document.querySelectorAll('.btn-increase').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        
                        // 1. Conta quantos já tem
                        const qtdAtual = carrinhoBruto.filter(item => item.id === id).length;

                        // 2. Verifica se passou de 3
                        if (qtdAtual >= 3) {
                            pendingItemId = id; // Guarda para usar no modal
                            qtyWarningModal.style.display = 'flex'; // Abre o aviso
                        } else {
                            // Se tem menos de 3, adiciona direto
                            const itemExemplo = carrinhoBruto.find(item => item.id === id);
                            if (itemExemplo) {
                                carrinhoBruto.push(itemExemplo);
                                salvarERenderizar();
                            }
                        }
                    });
                });
            }

            renderizarCarrinho();
        });
    </script>
</body>
</html>