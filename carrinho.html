<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>1234Farma - Carrinho</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* === MANTIDO EXATAMENTE IGUAL === */
        :root { 
            --tech-purple: #2E1A47;
            --neon-mint: #00D284;
            --page-bg: #FFFFFF;       
            --element-bg: #E9ECEF;    
            --white-pure: #FFFFFF;    
            --card-shadow: 0 4px 10px rgba(0,0,0,0.04);
            --warning-red: #ff4757; 
            --alert-orange: #ff9800; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Roboto, Arial, sans-serif; user-select: none;}
        
        body { 
            background-color: var(--page-bg); 
            color: var(--tech-purple); 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            font-size: 13px; 
        }
        
        /* HEADER */
        header { 
            background-color: var(--page-bg); 
            padding: 10px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--element-bg); 
            flex-shrink: 0; 
            height: 60px;
        }

        .btn-back-shop { 
            text-decoration: none; 
            color: var(--tech-purple); 
            display: flex; align-items: center; gap: 5px; font-weight: 700; 
            background-color: var(--element-bg);
            padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; 
            transition: 0.2s;
        }
        .btn-back-shop:active { background-color: #dbe0e4; }

        .brand-logo-text { font-size: 1.1rem; font-weight: 900; }
        .brand-1234 { color: var(--neon-mint); }
        .brand-farma { color: var(--tech-purple); }
        
        .user-info-center { text-align: center; line-height: 1.2; }
        .user-label { font-size: 0.7rem; color: #888; }

        /* CONTEÚDO PRINCIPAL */
        main { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; width: 100%; }
        
        .cart-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .page-title { font-size: 1.4rem; display: flex; align-items: center; gap: 8px; color: var(--tech-purple); margin: 0; font-weight: 800; }
        
        .btn-clear-cart { 
            background: none; border: 1px solid #ddd; color: #888; 
            padding: 6px 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.75rem; transition: all 0.3s; font-weight: 600;
        }
        .btn-clear-cart:hover { border-color: var(--warning-red); color: var(--warning-red); background-color: #fff5f5; }

        .cart-list-container { display: flex; flex-direction: column; gap: 12px; }
        
        /* CARD DE ITEM */
        .cart-item { 
            background-color: var(--element-bg); 
            border-radius: 12px; padding: 10px; 
            display: flex; justify-content: space-between; align-items: center; 
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        
        .cart-item-left { display: flex; align-items: center; gap: 12px; }
        
        .cart-item-img {
            width: 55px; height: 55px; 
            object-fit: contain; border-radius: 8px; 
            background-color: var(--white-pure);
            padding: 5px;
            mix-blend-mode: multiply;
        }

        .item-name { font-size: 0.95rem; font-weight: 700; margin-bottom: 3px; line-height: 1.1; color: var(--tech-purple); }
        .item-price-unit { font-size: 0.75rem; color: #777; }
        .item-price-total { color: var(--tech-purple); font-weight: 800; font-size: 0.95rem; margin-top: 2px;}

        /* CONTROLES DE QUANTIDADE */
        .quantity-controls {
            display: flex; align-items: center; gap: 8px;
            background-color: var(--white-pure); 
            padding: 4px 6px; border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .btn-qty {
            width: 26px; height: 26px; border-radius: 50%; border: none; cursor: pointer; 
            display: flex; justify-content: center; align-items: center; 
            transition: 0.2s;
        }
        .btn-decrease { background-color: #fff0f0; color: var(--warning-red); }
        .btn-decrease:active { background-color: var(--warning-red); color: white; }
        
        .qty-display { font-weight: 700; font-size: 0.95rem; min-width: 20px; text-align: center; color: var(--tech-purple); }
        
        .btn-increase { background-color: var(--neon-mint); color: var(--white-pure); }
        .btn-increase:active { background-color: var(--tech-purple); color: var(--neon-mint); }

        .empty-cart-message { text-align: center; padding: 40px; color: #999; font-size: 1.1rem; display: flex; flex-direction: column; align-items: center; gap: 15px;}
        
        /* BOTÃO VOLTAR PARA A LOJA NO CARRINHO VAZIO */
        .btn-empty-back {
            background-color: var(--tech-purple);
            color: var(--neon-mint);
            padding: 12px 25px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 800;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* FOOTER */
        footer { 
            background-color: var(--element-bg); padding: 15px; 
            border-top: none; flex-shrink: 0; 
        }
        .cart-total-summary { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 1.1rem; }
        .total-label { color: var(--tech-purple); font-weight: 600; }
        .total-value { color: var(--tech-purple); font-size: 1.5rem; font-weight: 900; }
        
        .btn-finish-order { 
            width: 100%; background-color: var(--neon-mint); color: var(--tech-purple); 
            padding: 14px; border-radius: 12px; font-weight: 800; border: none; 
            font-size: 1rem; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px;
            box-shadow: 0 4px 10px rgba(0, 210, 132, 0.2);
            transition: transform 0.1s;
        }
        .btn-finish-order:active { transform: scale(0.98); }

        /* MODAIS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(46, 26, 71, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none; 
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--white-pure);
            border: 2px solid var(--tech-purple);
            border-radius: 20px;
            padding: 30px;
            width: 85%; max-width: 350px;
            text-align: center;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            animation: modalPop 0.3s ease-out;
        }
        @keyframes modalPop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .modal-icon { font-size: 3.5rem; margin-bottom: 15px; }
        .modal-title { font-size: 1.3rem; font-weight: 800; color: var(--tech-purple); margin-bottom: 10px; }
        .modal-text { font-size: 1rem; color: #666; margin-bottom: 25px; line-height: 1.4; }
        .modal-actions { display: flex; gap: 15px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; font-size: 1rem;}
        .btn-modal-cancel { background-color: var(--element-bg); color: var(--tech-purple); }
        .modal-danger .modal-icon { color: var(--warning-red); }
        .modal-danger .btn-modal-confirm { background-color: var(--warning-red); color: white; }
        .modal-warning .modal-icon { color: var(--alert-orange); }
        .modal-warning .btn-modal-confirm { background-color: var(--alert-orange); color: white; }

    </style>
</head>
<body>

    <header>
        <a href="loja.html" class="btn-back-shop">
            <span class="material-icons" style="font-size: 1.1rem;">arrow_back</span>
        </a>
        
        <div class="user-info-center">
             <div class="user-label">Carrinho de</div>
             <div id="userNameDisplay" class="user-name-display">...</div>
        </div>

        <div class="brand-logo-text">
            <span class="brand-1234">1234</span><span class="brand-farma">Farma</span>
        </div>
    </header>

    <main>
        <div class="cart-header-row">
            <h1 class="page-title"><span class="material-icons" style="font-size: 1.6rem; color: var(--neon-mint);">shopping_cart</span> Seu Pedido</h1>
            <button id="btnClearCart" class="btn-clear-cart">
                <span class="material-icons" style="font-size: 1.1rem;">delete_outline</span> Esvaziar
            </button>
        </div>
        
        <div id="cartListContainer" class="cart-list-container"></div>
    </main>

    <footer>
        <div class="cart-total-summary">
            <span class="total-label">Total a pagar:</span>
            <span id="totalValueDisplay" class="total-value">R$ 0,00</span>
        </div>
        <button class="btn-finish-order">
            <span class="material-icons">payment</span> FINALIZAR PAGAMENTO
        </button>
    </footer>

    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content modal-danger">
            <div class="material-icons modal-icon">delete_forever</div>
            <div class="modal-title">Esvaziar Carrinho?</div>
            <div class="modal-text">Tem certeza que deseja remover todos os itens? Essa ação não pode ser desfeita.</div>
            <div class="modal-actions">
                <button id="btnCancelClear" class="modal-btn btn-modal-cancel">Cancelar</button>
                <button id="btnConfirmClear" class="modal-btn btn-modal-confirm">Sim, Esvaziar</button>
            </div>
        </div>
    </div>

    <div id="qtyWarningModal" class="modal-overlay">
        <div class="modal-content modal-warning">
            <div class="material-icons modal-icon">health_and_safety</div>
            <div class="modal-title">Atenção à Saúde</div>
            <div class="modal-text">
                Importante: O uso excessivo de qualquer medicamento sem a prescrição de um profissional pode causar prejuízos à sua saúde.
                <br><br>
                <strong>Deseja continuar comprando mais de 3 unidades desse medicamento?</strong>
            </div>
            <div class="modal-actions">
                <button id="btnCancelQty" class="modal-btn btn-modal-cancel">Não</button>
                <button id="btnConfirmQty" class="modal-btn btn-modal-confirm">Sim, desejo</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Verifica Login
            const nomeSalvo = sessionStorage.getItem('usuarioFarmaFacil');
            if (!nomeSalvo) { window.location.href = 'login.html'; return; }
            document.getElementById('userNameDisplay').textContent = nomeSalvo.split(' ')[0]; 
            
            // LER O CARRINHO
            let carrinhoBruto = JSON.parse(sessionStorage.getItem('carrinhoFarmaFacil')) || [];
            
            const cartListContainer = document.getElementById('cartListContainer');
            const totalValueDisplay = document.getElementById('totalValueDisplay');
            const btnClearCart = document.getElementById('btnClearCart');
            const btnFinish = document.querySelector('.btn-finish-order');
            
            // Modais
            const confirmModal = document.getElementById('confirmModal');
            const btnCancelClear = document.getElementById('btnCancelClear');
            const btnConfirmClear = document.getElementById('btnConfirmClear');
            const qtyWarningModal = document.getElementById('qtyWarningModal');
            const btnCancelQty = document.getElementById('btnCancelQty');
            const btnConfirmQty = document.getElementById('btnConfirmQty');

            let pendingItemId = null;

            // --- LÓGICA DE AGRUPAMENTO E RENDERIZAÇÃO ---
            function agruparItens(arrayBruto) {
                const agrupado = {};
                arrayBruto.forEach(item => {
                    if (agrupado[item.id]) {
                        agrupado[item.id].quantidade += 1;
                    } else {
                        agrupado[item.id] = { ...item, quantidade: 1 };
                    }
                });
                return Object.values(agrupado);
            }

            function renderizarCarrinho() {
                cartListContainer.innerHTML = ''; 
                let totalGeral = 0;

                if (carrinhoBruto.length === 0) {
                    btnClearCart.style.display = 'none'; 
                    cartListContainer.innerHTML = `
                        <div class="empty-cart-message">
                            <span class="material-icons" style="font-size: 4rem; opacity: 0.3;">shopping_cart_checkout</span>
                            <p>Seu carrinho está vazio.</p>
                            <a href="loja.html" class="btn-empty-back">
                                <span class="material-icons">store</span> VOLTAR PARA A LOJA
                            </a>
                        </div>`;
                    totalValueDisplay.textContent = 'R$ 0,00';
                    return;
                } else {
                    btnClearCart.style.display = 'flex';
                }

                const itensAgrupados = agruparItens(carrinhoBruto);

                itensAgrupados.forEach(produto => {
                    const precoTotalItem = produto.preco * produto.quantidade;
                    totalGeral += precoTotalItem;
                    
                    const itemElement = document.createElement('div');
                    itemElement.classList.add('cart-item');
                    
                    itemElement.innerHTML = `
                        <div class="cart-item-left">
                            <img src="${produto.imagem}" class="cart-item-img" alt="Foto" onerror="this.src='https://placehold.co/55x55/eee/999?text=X'">
                            <div>
                                <div class="item-name">${produto.nome}</div>
                                <div class="item-price-unit">Unit: R$ ${produto.preco.toFixed(2).replace('.',',')}</div>
                                <div class="item-price-total">Total: R$ ${precoTotalItem.toFixed(2).replace('.',',')}</div>
                            </div>
                        </div>

                        <div class="quantity-controls">
                            <button class="btn-qty btn-decrease" data-id="${produto.id}">
                                <span class="material-icons" style="font-size: 1rem;">remove</span>
                            </button>
                            
                            <span class="qty-display">${produto.quantidade}</span>
                            
                            <button class="btn-qty btn-increase" data-id="${produto.id}">
                                <span class="material-icons" style="font-size: 1rem;">add</span>
                            </button>
                        </div>
                    `;
                    cartListContainer.appendChild(itemElement);
                });

                totalValueDisplay.textContent = 'R$ ' + totalGeral.toFixed(2).replace('.',',');
                atribuirBotoes();
            }

            function salvarERenderizar() {
                sessionStorage.setItem('carrinhoFarmaFacil', JSON.stringify(carrinhoBruto));
                renderizarCarrinho();
            }

            // --- LÓGICA DOS BOTÕES + e - ---
            function atribuirBotoes() {
                // Botão DIMINUIR
                document.querySelectorAll('.btn-decrease').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        const index = carrinhoBruto.findIndex(item => item.id == id);
                        if (index !== -1) {
                            carrinhoBruto.splice(index, 1);
                            salvarERenderizar();
                        }
                    });
                });

                // Botão AUMENTAR
                document.querySelectorAll('.btn-increase').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        const qtdAtual = carrinhoBruto.filter(item => item.id == id).length;

                        if (qtdAtual >= 3) {
                            pendingItemId = id; 
                            qtyWarningModal.style.display = 'flex'; 
                        } else {
                            const itemExemplo = carrinhoBruto.find(item => item.id == id);
                            if (itemExemplo) {
                                carrinhoBruto.push(itemExemplo);
                                salvarERenderizar();
                            }
                        }
                    });
                });
            }

            // --- MODAIS ---
            btnClearCart.addEventListener('click', () => {
                if(carrinhoBruto.length > 0) confirmModal.style.display = 'flex';
            });
            btnCancelClear.addEventListener('click', () => confirmModal.style.display = 'none');
            btnConfirmClear.addEventListener('click', () => {
                carrinhoBruto = [];
                salvarERenderizar();
                confirmModal.style.display = 'none';
            });

            btnCancelQty.addEventListener('click', () => {
                qtyWarningModal.style.display = 'none';
                pendingItemId = null;
            });
            btnConfirmQty.addEventListener('click', () => {
                if(pendingItemId) {
                    const itemToAdd = carrinhoBruto.find(item => item.id == pendingItemId);
                    if(itemToAdd) {
                        carrinhoBruto.push(itemToAdd);
                        salvarERenderizar();
                    }
                }
                qtyWarningModal.style.display = 'none';
                pendingItemId = null;
            });

            // --- FINALIZAR ---
            btnFinish.addEventListener('click', function() {
                if (carrinhoBruto.length === 0) {
                    alert("Seu carrinho está vazio!");
                    return;
                }
                window.location.href = 'metodopagamento.html';
            });

            // Render Inicial
            renderizarCarrinho();
        });
    </script>
</body>
</html>